<?xml version="1.0" encoding="utf-8"?>
<odoo>

    <record id="view_picking_form_inherit_dispatch_control" model="ir.ui.view">
        <field name="name">stock.picking.form.dispatch.control</field>
        <field name="model">stock.picking</field>
        <field name="inherit_id" ref="stock.view_picking_form" />
        <field name="arch" type="xml">

            <xpath expr="//field[@name='origin']" position="after">
                <field name="referral_guide" invisible="picking_type_code != 'incoming'"
                    readonly="state in ('cancel')" />
            </xpath>
            <xpath expr="//field[@name='location_id']" position="after">
                <field name="shipping_guide" invisible="picking_type_code != 'outgoing'" readonly="state in ('done', 'cancel')" />
                <field name="shipping_guide_number"
                    invisible="shipping_guide == False"
                    readonly="state in ('done', 'cancel')"
                    placeholder="Ingrese número de guía..." />
            </xpath>
            <!-- Agregar la nueva página después del notebook existente -->
            <xpath expr="//notebook" position="inside">
                <page string="Control de despacho"
                    name="dispatch_control"
                    invisible="picking_type_code != 'outgoing'">

                    <!-- DATOS GENERALES -->
                    <group name="general_data" string="DATOS GENERALES">
                        <group name="transport_info_left" col="2">
                            <field name="transport_company_id"
                                options="{'no_create': False, 'no_open': True}"
                                readonly="state in ('done', 'cancel')" />
                            <field name="transport_phone" readonly="state in ('done', 'cancel')" />
                        </group>
                        <group name="transport_info_right" col="2">
                            <field name="vehicle_plate" readonly="state in ('done', 'cancel')" />
                        </group>
                    </group>

                    <!-- DOCUMENTACIÓN ENVIADA DEL PRODUCTO -->
                    <group name="documentation">
                        <group name="certificates_left" string="DOCUMENTACIÓN ENVIADA DEL PRODUCTO">
                            <field name="declaration_sworn" readonly="state in ('done', 'cancel')" />
                            <field name="certificate_microbiological"
                                readonly="state in ('done', 'cancel')" />
                        </group>
                        <group name="other_docs" string="OBSERVACIONES">
                            <field name="other_documents"
                                placeholder="Ingrese notas sobre otros documentos enviados..."
                                nolabel="1" />
                        </group>
                    </group>

                </page>
            </xpath>

            <!-- Hacer visible el campo product_packaging_id sin restricción de grupo -->
            <xpath
                expr="//field[@name='move_ids_without_package']//list//field[@name='product_packaging_id']"
                position="attributes">
                <attribute name="groups"></attribute>
                <attribute name="optional">show</attribute>
            </xpath>

            <!-- Agregar el campo de cantidad de embalaje después del embalaje -->
            <xpath
                expr="//field[@name='move_ids_without_package']//list//field[@name='product_packaging_id']"
                position="after">
                <field name="product_packaging_qty" string="Cant. Embalaje" optional="show"
                    readonly="not product_packaging_id"
                    invisible="not product_packaging_id" />
            </xpath>

        </field>
    </record>

</odoo>